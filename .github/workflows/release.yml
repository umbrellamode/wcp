name: Release

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  release:
    name: Build and Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Get version from deno.json
        id: version
        run: |
          VERSION=$(jq -r '.version' deno.json)
          echo "version=v$VERSION" >> $GITHUB_OUTPUT
          echo "Version: v$VERSION"

      - name: Check if release exists
        id: check_release
        run: |
          if gh release view ${{ steps.version.outputs.version }} > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.TOKEN }}

      - name: Compile binaries
        if: steps.check_release.outputs.exists == 'false'
        run: |
          mkdir -p dist
          deno compile --allow-net --allow-read --allow-write --allow-run --allow-env --target aarch64-apple-darwin --output dist/wcp-darwin-arm64 mod.ts
          deno compile --allow-net --allow-read --allow-write --allow-run --allow-env --target x86_64-apple-darwin --output dist/wcp-darwin-x64 mod.ts
          deno compile --allow-net --allow-read --allow-write --allow-run --allow-env --target x86_64-unknown-linux-gnu --output dist/wcp-linux-x64 mod.ts

      - name: Create release
        if: steps.check_release.outputs.exists == 'false'
        run: |
          gh release create ${{ steps.version.outputs.version }} \
            dist/wcp-darwin-arm64 \
            dist/wcp-darwin-x64 \
            dist/wcp-linux-x64 \
            --title "${{ steps.version.outputs.version }}" \
            --generate-notes
        env:
          GH_TOKEN: ${{ secrets.TOKEN }}

      - name: Skip release
        if: steps.check_release.outputs.exists == 'true'
        run: echo "Release ${{ steps.version.outputs.version }} already exists, skipping..."

  update-homebrew:
    name: Update Homebrew Tap
    runs-on: ubuntu-latest
    needs: release

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from deno.json
        id: version
        run: |
          VERSION=$(jq -r '.version' deno.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Get release info
        id: release
        run: |
          RELEASE_JSON=$(gh release view v${{ steps.version.outputs.version }} --repo umbrellamode/wcp --json assets)
          echo "sha_darwin_arm64=$(echo $RELEASE_JSON | jq -r '.assets[] | select(.name == \"wcp-darwin-arm64\") | .digest' | sed 's/sha256://')" >> $GITHUB_OUTPUT
          echo "sha_darwin_x64=$(echo $RELEASE_JSON | jq -r '.assets[] | select(.name == \"wcp-darwin-x64\") | .digest' | sed 's/sha256://')" >> $GITHUB_OUTPUT
          echo "sha_linux_x64=$(echo $RELEASE_JSON | jq -r '.assets[] | select(.name == \"wcp-linux-x64\") | .digest' | sed 's/sha256://')" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.TOKEN }}

      - name: Clone homebrew-tap
        run: |
          gh repo clone umbrellamode/homebrew-tap homebrew-tap || {
            gh repo create umbrellamode/homebrew-tap --public --description "Homebrew tap for umbrellamode projects"
            gh repo clone umbrellamode/homebrew-tap homebrew-tap
          }
        env:
          GH_TOKEN: ${{ secrets.TOKEN }}

      - name: Update formula
        run: |
          mkdir -p homebrew-tap/Formula
          cat > homebrew-tap/Formula/wcp.rb << EOF
          class Wcp < Formula
            desc "Bidirectional log streaming CLI for AI coding agents"
            homepage "https://wcp.dev"
            version "${{ steps.version.outputs.version }}"
            license "MIT"

            on_macos do
              on_arm do
                url "https://github.com/umbrellamode/wcp/releases/download/v#{version}/wcp-darwin-arm64"
                sha256 "${{ steps.release.outputs.sha_darwin_arm64 }}"
              end
              on_intel do
                url "https://github.com/umbrellamode/wcp/releases/download/v#{version}/wcp-darwin-x64"
                sha256 "${{ steps.release.outputs.sha_darwin_x64 }}"
              end
            end

            on_linux do
              on_intel do
                url "https://github.com/umbrellamode/wcp/releases/download/v#{version}/wcp-linux-x64"
                sha256 "${{ steps.release.outputs.sha_linux_x64 }}"
              end
            end

            def install
              binary_name = stable.url.split("/").last
              bin.install binary_name => "wcp"
            end

            test do
              assert_match "wcp", shell_output("#{bin}/wcp --version")
            end
          end
          EOF
          # Fix indentation
          sed -i 's/^          //' homebrew-tap/Formula/wcp.rb

      - name: Push to homebrew-tap
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${{ secrets.TOKEN }}@github.com/umbrellamode/homebrew-tap.git
          git add Formula/wcp.rb
          git diff --staged --quiet || {
            git commit -m "Update wcp to ${{ steps.version.outputs.version }}"
            git push
          }
        env:
          GH_TOKEN: ${{ secrets.TOKEN }}
